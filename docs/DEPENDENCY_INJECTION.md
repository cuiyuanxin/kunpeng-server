# 依赖注入系统

本项目使用 Google Wire 实现编译时依赖注入，提供类型安全、高性能的依赖管理。

## 核心组件

### 1. Wire 配置

Wire 使用编译时代码生成来实现依赖注入，避免了运行时反射的性能开销。

```go
//go:build wireinject
// +build wireinject

package wire

import (
    "github.com/google/wire"
    "github.com/cuiyuanxin/kunpeng/internal/config"
    "github.com/cuiyuanxin/kunpeng/internal/service"
    "github.com/cuiyuanxin/kunpeng/pkg/auth"
)

// 提供者函数
func ProvideJWTManager(cfg *config.Config) *auth.JWTManager {
    jwtConfig := &auth.JWTConfig{
        Secret:     cfg.JWT.Secret,
        ExpireTime: cfg.JWT.ExpireTime,
        Issuer:     cfg.JWT.Issuer,
    }
    return auth.NewJWTManager(jwtConfig)
}

func ProvideUserService(db *gorm.DB) *service.UserService {
    return service.NewUserServiceWithDB(db)
}

// Wire 集合
var AppSet = wire.NewSet(
    ProvideJWTManager,
    ProvideUserService,
    // ... 其他提供者
)

// 初始化函数（Wire 将生成实现）
func InitializeApp(cfg *config.Config, db *gorm.DB) *App {
    wire.Build(AppSet)
    return &App{}
}
```

### 2. 应用程序结构

Wire 生成的应用程序结构包含所有依赖的服务。

```go
type App struct {
    Config                 *config.Config
    DB                     *gorm.DB
    JWTManager             *auth.JWTManager
    UserService            *service.UserService
    AdminUserService       *service.AdminUserService
    AdminRoleService       *service.AdminRoleService
    AdminPermissionService *service.AdminPermissionService
    AdminDepartmentService *service.AdminDepartmentService
    PermissionService      *service.PermissionService
}

// 使用 Wire 初始化应用程序
app := wire.InitializeApp(cfg, database.GetDB())
```

### 3. 代码生成

Wire 在编译时生成依赖注入代码，确保类型安全和高性能。

```bash
# 生成 Wire 代码
wire ./internal/wire

# 生成的文件：wire_gen.go
// Code generated by Wire. DO NOT EDIT.

func InitializeApp(cfg *config.Config, db *gorm.DB) *App {
    jwtManager := ProvideJWTManager(cfg)
    userService := ProvideUserService(db)
    adminUserService := ProvideAdminUserService(db)
    // ... 其他服务初始化
    app := ProvideApp(cfg, db, jwtManager, userService, adminUserService, ...)
    return app
}
```

## 使用方式

### 1. 传统方式（手动传递依赖）

```go
// 手动创建依赖
cfg := config.Load()
db := database.Connect(cfg)
jwtManager := auth.NewJWTManager(cfg.JWT)
userService := service.NewUserService(db)

// 创建路由
r := router.NewRouter(cfg, userService, adminService, db)
```

### 2. Wire 依赖注入方式

```go
// 使用 Wire 初始化应用程序
app := wire.InitializeApp(cfg, database.GetDB())

// 使用 Wire 应用程序创建路由
r := router.NewRouterWithWire(app)
```

## 优势

### 1. 编译时安全
- Wire 在编译时生成代码，确保类型安全
- 编译时检查依赖关系，避免运行时错误
- 无需反射，性能优异

### 2. 代码可读性
- 生成的代码清晰易懂
- 依赖关系明确可见
- 便于调试和维护

### 3. 零运行时开销
- 编译时代码生成，无运行时反射
- 直接函数调用，性能最优
- 内存占用最小

### 4. 易于测试
- 依赖关系明确，便于模拟
- 支持依赖替换
- 单元测试友好

## 最佳实践

### 1. 提供者函数

```go
// 推荐：清晰的提供者函数
func ProvideUserService(db *gorm.DB) *service.UserService {
    return service.NewUserServiceWithDB(db)
}

// 推荐：复杂依赖的提供者
func ProvideJWTManager(cfg *config.Config) *auth.JWTManager {
    jwtConfig := &auth.JWTConfig{
        Secret:     cfg.JWT.Secret,
        ExpireTime: cfg.JWT.ExpireTime,
        Issuer:     cfg.JWT.Issuer,
    }
    return auth.NewJWTManager(jwtConfig)
}
```

### 2. Wire 集合组织

```go
// 推荐：按功能模块组织 Wire 集合
var DatabaseSet = wire.NewSet(
    ProvideUserService,
    ProvideAdminUserService,
    ProvideAdminRoleService,
)

var AuthSet = wire.NewSet(
    ProvideJWTManager,
    ProvidePermissionService,
)

var AppSet = wire.NewSet(
    DatabaseSet,
    AuthSet,
    ProvideApp,
)
```

### 3. 测试支持

```go
// 测试时使用独立的初始化函数
func TestUserHandler(t *testing.T) {
    // 创建测试配置和数据库
    cfg := &config.Config{...}
    db, _ := gorm.Open(sqlite.Open(":memory:"), &gorm.Config{})
    
    // 使用 Wire 初始化测试应用
    app := wire.InitializeApp(cfg, db)
    
    // 测试服务
    assert.NotNil(t, app.UserService)
    // ...
}
```